<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>KÃ¼tÃ¼phanem</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  padding:20px;
}
.box{
  max-width:900px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:8px;
}
h2{text-align:center;}
.admin-box{
  background:#eef3ff;
  padding:15px;
  border-radius:6px;
  margin-bottom:20px;
}
input,button{
  padding:10px;
  width:100%;
  margin-top:8px;
  font-size:16px;
}
button{
  background:#1976d2;
  color:#fff;
  border:none;
  cursor:pointer;
}
.count{
  text-align:center;
  margin:10px 0;
  color:#555;
}
ul{list-style:none;padding:0;}
li{
  padding:10px;
  border-bottom:1px solid #eee;
}
.raf{font-size:14px;color:#666;}
.hidden{display:none;}
#kamera{width:100%;}
</style>
</head>

<body>
<div class="box">
  <h2>ðŸ“š KÃ¼tÃ¼phanem</h2>

  <!-- ADMIN EKLEME -->
  <div id="adminAlan" class="admin-box hidden">
    <b>âž• Kitap Ekle (Admin)</b>

    <input id="isbn" placeholder="ISBN">
    <button onclick="isbnAra()">ISBN Ara</button>

    <button onclick="kamerayiAc()">ðŸ“· Barkod Okut</button>

    <div id="kameraAlan" class="hidden">
      <div id="kamera"></div>
      <button onclick="kamerayiKapat()">KamerayÄ± Kapat</button>
    </div>

    <div id="bulunan" style="margin-top:8px;"></div>

    <input id="raf" placeholder="Raf (Ã¶rn: Salon / A-2)">
    <button onclick="kaydet()">Kaydet</button>
  </div>

  <!-- ARAMA -->
  <input id="arama" placeholder="Kitap ara..." onkeyup="filtrele()">

  <div class="count" id="sayac">YÃ¼kleniyor...</div>

  <!-- LÄ°STE -->
  <ul id="liste"></ul>
</div>

<!-- Quagga (Barkod) -->
<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ðŸ”´ ADMIN MAÄ°LÄ°NÄ° BURAYA YAZ */
const ADMIN_MAIL = "admin@gmail.com";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCKYXjtL0jAvcxTD09NzsQelA0ipYQFr0s",
  authDomain: "kitap-arsivi-8efa5.firebaseapp.com",
  projectId: "kitap-arsivi-8efa5",
  storageBucket: "kitap-arsivi-8efa5.firebasestorage.app",
  messagingSenderId: "712225906954",
  appId: "1:712225906954:web:b4e317515cefa3d3c89af3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let kitaplar = [];
let bulunanKitap = null;

/* AUTH + ADMIN */
onAuthStateChanged(auth, user=>{
  if(!user){
    alert("GiriÅŸ yapmalÄ±sÄ±n");
    window.location.href="index.html";
    return;
  }
  if(user.email === ADMIN_MAIL){
    document.getElementById("adminAlan").classList.remove("hidden");
  }
});

/* ISBN ARA */
window.isbnAra = async function(){
  const isbn = document.getElementById("isbn").value.trim();
  if(!isbn) return alert("ISBN gir");

  const div = document.getElementById("bulunan");
  div.innerText="AranÄ±yor...";

  try{
    const r = await fetch(`https://openlibrary.org/isbn/${isbn}.json`);
    if(!r.ok) throw new Error();
    const d = await r.json();

    bulunanKitap = { isbn, ad:d.title };
    div.innerHTML = "ðŸ“– <b>"+d.title+"</b>";
  }catch{
    div.innerText="âŒ Kitap bulunamadÄ±";
    bulunanKitap=null;
  }
};

/* KAYDET */
window.kaydet = async function(){
  if(!bulunanKitap) return alert("Ã–nce ISBN ara");
  const raf = document.getElementById("raf").value.trim();
  if(!raf) return alert("Raf bilgisi gir");

  await addDoc(collection(db,"kutuphane"),{
    isbn: bulunanKitap.isbn,
    kitapAdi: bulunanKitap.ad,
    raf: raf,
    tarih: serverTimestamp()
  });

  alert("âœ… Kitap eklendi");
  location.reload();
};

/* LÄ°STE YÃœKLE */
async function yukle(){
  const q = query(collection(db,"kutuphane"), orderBy("kitapAdi"));
  const snap = await getDocs(q);
  kitaplar=[];
  snap.forEach(d=>kitaplar.push(d.data()));
  document.getElementById("sayac").innerText="Toplam kitap: "+kitaplar.length;
  listele(kitaplar);
}

/* LÄ°STE */
function listele(arr){
  const ul=document.getElementById("liste");
  ul.innerHTML="";
  if(arr.length===0){ul.innerHTML="<li>SonuÃ§ yok</li>";return;}
  arr.forEach(k=>{
    const li=document.createElement("li");
    li.innerHTML=`<b>${k.kitapAdi}</b><br><span class="raf">Raf: ${k.raf}</span>`;
    ul.appendChild(li);
  });
}

/* FÄ°LTRE */
window.filtrele=function(){
  const t=document.getElementById("arama").value.toLowerCase();
  listele(kitaplar.filter(k=>k.kitapAdi.toLowerCase().includes(t)));
};

/* KAMERA */
window.kamerayiAc=function(){
  document.getElementById("kameraAlan").classList.remove("hidden");

  Quagga.init({
    inputStream:{
      type:"LiveStream",
      target:document.querySelector("#kamera"),
      constraints:{ facingMode:"environment" }
    },
    decoder:{ readers:["ean_reader","ean_13_reader"] }
  },err=>{
    if(err){ alert("Kamera aÃ§Ä±lamadÄ±"); return; }
    Quagga.start();
  });

  Quagga.onDetected(data=>{
    const code=data.codeResult.code;
    if(code && code.length>=12){
      document.getElementById("isbn").value=code;
      kamerayiKapat();
      isbnAra();
    }
  });
};

window.kamerayiKapat=function(){
  Quagga.stop();
  document.getElementById("kameraAlan").classList.add("hidden");
};

yukle();
</script>
</body>
</html>
