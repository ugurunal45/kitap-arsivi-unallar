<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>KÃ¼tÃ¼phane</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f5f5f5;
  padding: 15px;
}
h2 { margin-top: 0; }

input, select, button {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
  font-size: 16px;
}

button {
  background: #2c7be5;
  color: white;
  border: none;
  border-radius: 5px;
}

#kameraAlan {
  position: fixed;
  inset: 0;
  background: black;
  display: none;
  z-index: 9999;
}
video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.kitap {
  background: white;
  padding: 10px;
  margin-top: 8px;
  border-radius: 6px;
  font-size: 15px;
}
.hidden { display: none; }
</style>
</head>

<body>

<h2>ðŸ“š KÃ¼tÃ¼phane</h2>

<input id="isbn" placeholder="ISBN" />
<button onclick="kamerayiAc()">ðŸ“· Barkod Oku</button>

<input id="kitapAdi" placeholder="Kitap adÄ±" readonly />

<select id="raf">
  <option value="">Raf seÃ§</option>
  <option>Raf 1</option>
  <option>Raf 2</option>
  <option>Raf 3</option>
</select>

<button onclick="kitapKaydet()">ðŸ’¾ KitabÄ± Kaydet</button>

<h3>ðŸ“– Kitaplar</h3>
<div id="liste"></div>

<!-- Kamera -->
<div id="kameraAlan">
  <video id="video" autoplay playsinline></video>
  <button onclick="kamerayiKapat()">Kapat</button>
</div>

<!-- Quagga -->
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "API_KEY",
  authDomain: "PROJECT.firebaseapp.com",
  projectId: "PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const kitaplarRef = collection(db, "kitaplar");

let stream;
let barcodeDetector;

/* ================== KAMERA ================== */

window.kamerayiAc = async function () {
  document.getElementById("kameraAlan").style.display = "block";

  if ("BarcodeDetector" in window) {
    barcodeDetector = new BarcodeDetector({ formats: ["ean_13", "ean_8"] });
    nativeScan();
  } else {
    quaggaScan();
  }
};

async function nativeScan() {
  const video = document.getElementById("video");

  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
  });

  video.srcObject = stream;

  const scan = async () => {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      const codes = await barcodeDetector.detect(video);
      if (codes.length > 0) {
        document.getElementById("isbn").value = codes[0].rawValue;
        kamerayiKapat();
        isbnAra();
        return;
      }
    }
    requestAnimationFrame(scan);
  };
  scan();
}

function quaggaScan() {
  Quagga.init({
    inputStream: {
      type: "LiveStream",
      target: document.querySelector("#video"),
      constraints: { facingMode: "environment" }
    },
    decoder: { readers: ["ean_reader", "ean_13_reader"] }
  }, err => {
    if (!err) Quagga.start();
  });

  Quagga.onDetected(data => {
    document.getElementById("isbn").value = data.codeResult.code;
    kamerayiKapat();
    isbnAra();
  });
}

window.kamerayiKapat = function () {
  document.getElementById("kameraAlan").style.display = "none";
  if (stream) stream.getTracks().forEach(t => t.stop());
  if (window.Quagga) Quagga.stop();
};

/* ================== ISBN ARA ================== */

window.isbnAra = async function () {
  const isbn = document.getElementById("isbn").value;
  if (!isbn) return;

  try {
    const res = await fetch(`https://isbnsearch.org/isbn/${isbn}`);
    const html = await res.text();
    const doc = new DOMParser().parseFromString(html, "text/html");
    const title = doc.querySelector("h1")?.innerText || "BulunamadÄ±";
    document.getElementById("kitapAdi").value = title;
  } catch {
    alert("Kitap bulunamadÄ±");
  }
};

/* ================== KAYDET ================== */

window.kitapKaydet = async function () {
  const isbn = isbn.value;
  const kitapAdi = document.getElementById("kitapAdi").value;
  const raf = document.getElementById("raf").value;

  if (!isbn || !kitapAdi || !raf) {
    alert("Eksik bilgi");
    return;
  }

  await addDoc(kitaplarRef, {
    isbn,
    kitapAdi,
    raf,
    tarih: new Date()
  });

  alert("Kaydedildi");
  listele();
};

/* ================== LÄ°STE ================== */

async function listele() {
  liste.innerHTML = "";
  const snap = await getDocs(kitaplarRef);
  snap.forEach(d => {
    const k = d.data();
    liste.innerHTML += `
      <div class="kitap">
        <b>${k.kitapAdi}</b><br>
        ISBN: ${k.isbn}<br>
        Raf: ${k.raf}
      </div>`;
  });
}

listele();
</script>

</body>
</html>
