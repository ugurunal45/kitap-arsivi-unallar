<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Kitap ArÅŸivi</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { 
  getAuth, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* ðŸ” ADMIN MAIL */
const ADMIN_EMAIL = "admin@unallar.com";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyCKYXjtL0jAvcxTD09NzsQelA0ipYQFr0s",
  authDomain: "kitap-arsivi-8efa5.firebaseapp.com",
  projectId: "kitap-arsivi-8efa5",
  storageBucket: "kitap-arsivi-8efa5.firebasestorage.app",
  messagingSenderId: "712225906954",
  appId: "1:712225906954:web:b4e317515cefa3d3c89af3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const kitapRef = collection(db, "kitap-arsivi");

let tumKitaplar = [];
let adminMi = false;

/* ðŸ” AUTH KONTROL */
onAuthStateChanged(auth, user => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  adminMi = user.email === ADMIN_EMAIL;

  document.getElementById("adminPanel").style.display = adminMi ? "block" : "none";
});

/* ðŸ“š LÄ°STELE */
async function kitaplariGetir() {
  const liste = document.getElementById("kitapListesi");
  const sayac = document.getElementById("sayac");

  liste.innerHTML = "";
  tumKitaplar = [];

  const q = query(kitapRef, orderBy("ad"));
  const snap = await getDocs(q);

  snap.forEach(doc => {
    const d = doc.data();
    const ad = d.ad || d.kitapAdi;
    if (ad) tumKitaplar.push(ad);
  });

  sayac.textContent = "Toplam Kitap: " + tumKitaplar.length;
  listele(tumKitaplar);
}

function listele(arr) {
  const liste = document.getElementById("kitapListesi");
  liste.innerHTML = "";
  arr.forEach(a => {
    const li = document.createElement("li");
    li.textContent = a;
    liste.appendChild(li);
  });
}

/* ðŸ” ARAMA */
window.ara = () => {
  const q = document.getElementById("arama").value.toLowerCase();
  listele(tumKitaplar.filter(k => k.toLowerCase().includes(q)));
};

/* âž• TEK EKLE */
window.kitapEkle = async () => {
  if (!adminMi) return;
  const ad = document.getElementById("tekKitap").value.trim();
  if (!ad) return;

  await addDoc(kitapRef, { ad, tarih: serverTimestamp() });
  document.getElementById("tekKitap").value = "";
  kitaplariGetir();
};

/* ðŸ“‚ CSV YÃœKLE */
window.csvYukle = async () => {
  if (!adminMi) return;

  const file = document.getElementById("csvFile").files[0];
  if (!file) return alert("CSV seÃ§");

  const text = await file.text();
  const satirlar = text.split("\n").map(s => s.trim()).filter(s => s);

  for (const kitap of satirlar) {
    await addDoc(kitapRef, { ad: kitap, tarih: serverTimestamp() });
  }

  alert(satirlar.length + " kitap yÃ¼klendi");
  document.getElementById("csvFile").value = "";
  kitaplariGetir();
};

window.onload = kitaplariGetir;
</script>

<style>
body { font-family: Arial; background:#f2f4f7; }
.box { max-width:900px; margin:30px auto; background:#fff; padding:20px; border-radius:10px; }
input, button { width:100%; padding:10px; margin:5px 0; }
button { background:#007bff; color:white; border:none; cursor:pointer; }
ul { list-style:none; padding:0; max-height:400px; overflow:auto; }
li { padding:6px; border-bottom:1px solid #eee; }
#adminPanel { display:none; border-top:2px dashed #ccc; margin-top:15px; padding-top:15px; }
.sayac { text-align:center; font-weight:bold; }
</style>
</head>

<body>
<div class="box">
  <h1>ðŸ“š Kitap ArÅŸivi</h1>
  <div id="sayac" class="sayac">Toplam Kitap: 0</div>

  <input id="arama" placeholder="Kitap ara..." onkeyup="ara()">

  <!-- ðŸ” ADMIN PANEL -->
  <div id="adminPanel">
    <h3>âž• Tek Kitap</h3>
    <input id="tekKitap" placeholder="Kitap adÄ±">
    <button onclick="kitapEkle()">Ekle</button>

    <h3>ðŸ“‚ CSV ile Toplu YÃ¼kleme</h3>
    <input type="file" id="csvFile" accept=".csv">
    <button onclick="csvYukle()">CSV YÃ¼kle</button>
  </div>

  <ul id="kitapListesi"></ul>
</div>
</body>
</html>
