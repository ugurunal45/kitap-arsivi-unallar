<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Kitap ArÅŸivi | Admin Paneli</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, writeBatch, doc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { 
  getAuth, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* ðŸ” ADMIN AYARI */
const ADMIN_EMAIL = "admin@unallar.com";

const firebaseConfig = {
  apiKey: "AIzaSyCKYXjtL0jAvcxTD09NzsQelA0ipYQFr0s",
  authDomain: "kitap-arsivi-8efa5.firebaseapp.com",
  projectId: "kitap-arsivi-8efa5",
  storageBucket: "kitap-arsivi-8efa5.firebasestorage.app",
  messagingSenderId: "712225906954",
  appId: "1:712225906954:web:b4e317515cefa3d3c89af3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const kitapRef = collection(db, "kitap-arsivi");

let tumKitaplar = [];
let adminMi = false;

/* ðŸ” GÄ°RÄ°Åž KONTROLÃœ */
onAuthStateChanged(auth, user => {
  if (!user) {
    window.location.href = "index.html"; // index-2.html'in adÄ±nÄ± index.html yapmayÄ± unutma
    return;
  }

  adminMi = user.email === ADMIN_EMAIL;
  // Sadece admin ise panel gÃ¶rÃ¼nÃ¼r
  document.getElementById("adminPanel").style.display = adminMi ? "block" : "none";
  kitaplariGetir();
});

/* ðŸ“š KÄ°TAPLARI LÄ°STELE VE SAY */
async function kitaplariGetir() {
  const sayac = document.getElementById("sayac");
  const liste = document.getElementById("kitapListesi");
  
  liste.innerHTML = "<li>YÃ¼kleniyor...</li>";
  tumKitaplar = [];

  try {
    const q = query(kitapRef, orderBy("tarih", "desc"));
    const snap = await getDocs(q);

    snap.forEach(docSnap => {
      const d = docSnap.data();
      tumKitaplar.push({ id: docSnap.id, ...d });
    });

    sayac.textContent = "Toplam Kitap: " + tumKitaplar.length; // Toplam sayÄ±yÄ± gÃ¶sterir
    listele(tumKitaplar);
  } catch (error) {
    console.error("Veri Ã§ekme hatasÄ±:", error);
    liste.innerHTML = "<li>Veriler yÃ¼klenemedi.</li>";
  }
}

function listele(arr) {
  const liste = document.getElementById("kitapListesi");
  liste.innerHTML = "";
  arr.forEach(k => {
    const li = document.createElement("li");
    li.className = "kitap-item";
    li.innerHTML = `<strong>${k.ad}</strong> ${k.yazar ? ' - ' + k.yazar : ''}`;
    liste.appendChild(li);
  });
}

/* ðŸ” ARAMA FONKSÄ°YONU */
window.ara = () => {
  const q = document.getElementById("arama").value.toLowerCase();
  const filtreli = tumKitaplar.filter(k => 
    k.ad.toLowerCase().includes(q) || (k.yazar && k.yazar.toLowerCase().includes(q))
  );
  listele(filtreli);
};

/* ðŸ“‚ CSV TOPLU YÃœKLEME (GELÄ°ÅžTÄ°RÄ°LMÄ°Åž) */
window.csvYukle = async () => {
  if (!adminMi) return alert("Yetkiniz yok!");

  const fileInput = document.getElementById("csvFile");
  const file = fileInput.files[0];
  if (!file) return alert("LÃ¼tfen bir CSV dosyasÄ± seÃ§in.");

  const text = await file.text();
  const satirlar = text.split("\n").map(s => s.trim()).filter(s => s);
  
  // 700+ kitap olduÄŸu iÃ§in "Batch" (Toplu Ä°ÅŸlem) kullanÄ±yoruz
  const batch = writeBatch(db);
  let count = 0;

  satirlar.forEach(satir => {
    // CSV formatÄ±: Kitap AdÄ±, Yazar, ISBN ÅŸeklinde olabilir
    const hucreler = satir.split(","); 
    const yeniKitap = {
      ad: hucreler[0] || "Ä°simsiz Kitap",
      yazar: hucreler[1] || "Bilinmiyor",
      isbn: hucreler[2] || "",
      tarih: serverTimestamp()
    };
    
    const yeniDocRef = doc(kitapRef);
    batch.set(yeniDocRef, yeniKitap);
    count++;
  });

  await batch.commit();
  alert(count + " kitap baÅŸarÄ±yla eklendi!");
  fileInput.value = "";
  kitaplariGetir();
};

// Fonksiyonu window nesnesine baÄŸlamalÄ±yÄ±z ki HTML'den eriÅŸilebilsin
window.kitapEkle = async () => {
  const ad = document.getElementById("tekKitap").value.trim();
  if (!ad || !adminMi) return;

  await addDoc(kitapRef, { 
    ad, 
    yazar: "Bilinmiyor", 
    tarih: serverTimestamp() 
  });
  document.getElementById("tekKitap").value = "";
  kitaplariGetir();
};

</script>

<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f0f2f5; color: #333; }
  .box { max-width:600px; margin:30px auto; background:#fff; padding:25px; border-radius:12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
  h1 { text-align: center; color: #1a73e8; }
  .sayac { background: #e8f0fe; padding: 10px; border-radius: 8px; text-align:center; font-weight:bold; margin-bottom: 20px; color: #1967d2; }
  input, button { width:100%; padding:12px; margin:8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
  button { background:#1a73e8; color:white; border:none; cursor:pointer; font-weight: bold; transition: 0.3s; }
  button:hover { background: #1557b0; }
  ul { list-style:none; padding:0; max-height:400px; overflow-y:auto; margin-top: 20px; }
  .kitap-item { padding:12px; border-bottom:1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
  .kitap-item:last-child { border-bottom: none; }
  #adminPanel { display:none; border: 2px solid #e8f0fe; padding: 15px; border-radius: 8px; margin-top: 20px; background: #fafafa; }
  h3 { margin-top: 0; font-size: 16px; color: #555; }
</style>
</head>

<body>
<div class="box">
  <h1>ðŸ“š Kitap ArÅŸivi</h1>
  <div id="sayac" class="sayac">Kitaplar hesaplanÄ±yor...</div>

  <input id="arama" placeholder="Kitap veya yazar ara..." onkeyup="ara()">

  <div id="adminPanel">
    <h3>âž• Yeni Kitap Ekle</h3>
    <input id="tekKitap" placeholder="Kitap adÄ± yazÄ±n...">
    <button onclick="kitapEkle()">Tekli Ekle</button>

    <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

    <h3>ðŸ“‚ Toplu CSV YÃ¼kle</h3>
    <p style="font-size: 12px; color: #666;">Format: Kitap AdÄ±, Yazar, ISBN</p>
    <input type="file" id="csvFile" accept=".csv">
    <button onclick="csvYukle()" style="background: #34a853;">Verileri Sisteme YÃ¼kle</button>
  </div>

  <ul id="kitapListesi"></ul>
</div>
</body>
</html>
