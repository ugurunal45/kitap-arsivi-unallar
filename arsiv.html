<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Kitap ArÅŸivi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial, sans-serif; margin:20px; }
header { display:flex; justify-content:space-between; align-items:center; }
.box { border:1px solid #ccc; padding:15px; margin:15px 0; }
input, button { padding:8px; margin-top:5px; }
ul { padding-left:20px; }
li { margin-bottom:6px; }
.hidden { display:none; }
.delete-btn { color:red; border:1px solid red; background:none; margin-left:10px; }
</style>
</head>

<body>

<header>
  <h2>ðŸ“š Kitap ArÅŸivi</h2>
  <button id="logoutBtn">Ã‡Ä±kÄ±ÅŸ</button>
</header>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="box hidden">
  <h3>âž• Kitap Ekle</h3>
  <input id="kitapAdi" placeholder="Kitap AdÄ±">
  <button id="ekleBtn">Ekle</button>

  <hr>

  <h3>ðŸ“‚ CSV ile Toplu YÃ¼kleme</h3>
  <input type="file" id="csvFile" accept=".csv">
  <button id="csvUploadBtn">CSV YÃ¼kle</button>
  <p id="csvStatus"></p>
</div>

<div class="box">
  <input id="aramaInput" placeholder="Kitap ara">
  <button id="araBtn">Ara</button>
</div>

<ul id="kitapListesi"></ul>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const ADMIN_EMAIL = "admin@unallar.com";

const firebaseConfig = {
  apiKey: "AIzaSyCKYXjtL0jAvcxTD09NzsQelA0ipYQFr0s",
  authDomain: "kitap-arsivi-8efa5.firebaseapp.com",
  projectId: "kitap-arsivi-8efa5",
  storageBucket: "kitap-arsivi-8efa5.firebasestorage.app",
  messagingSenderId: "712225906954",
  appId: "1:712225906954:web:b4e317515cefa3d3c89af3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let tumKitaplar = [];
let isAdmin = false;

const adminPanel = document.getElementById("adminPanel");
const kitapListesi = document.getElementById("kitapListesi");

onAuthStateChanged(auth, user => {
  if (!user) location.href = "index.html";
  isAdmin = user.email === ADMIN_EMAIL;
  if (isAdmin) adminPanel.classList.remove("hidden");
  kitaplariYukle();
});

logoutBtn.onclick = async () => {
  await signOut(auth);
  location.href = "index.html";
};

async function kitaplariYukle(){
  kitapListesi.innerHTML="";
  tumKitaplar=[];
  const snap = await getDocs(collection(db,"kitaplar"));
  snap.forEach(d => tumKitaplar.push({id:d.id, ad:d.data().ad}));
  listele(tumKitaplar);
}

function listele(liste){
  kitapListesi.innerHTML="";
  liste.forEach(k=>{
    const li=document.createElement("li");
    li.textContent=k.ad;

    if(isAdmin){
      const b=document.createElement("button");
      b.textContent="Sil";
      b.className="delete-btn";
      b.onclick=async()=>{
        if(confirm(k.ad+" silinsin mi?")){
          await deleteDoc(doc(db,"kitaplar",k.id));
          kitaplariYukle();
        }
      };
      li.appendChild(b);
    }
    kitapListesi.appendChild(li);
  });
}

ekleBtn.onclick = async ()=>{
  if(!isAdmin) return;
  const ad = kitapAdi.value.trim();
  if(!ad) return alert("Kitap adÄ± boÅŸ");
  await addDoc(collection(db,"kitaplar"),{ad});
  kitapAdi.value="";
  kitaplariYukle();
};

araBtn.onclick=()=>{
  const q=aramaInput.value.toLowerCase();
  listele(tumKitaplar.filter(k=>k.ad.toLowerCase().includes(q)));
};

// CSV YÃœKLEME
csvUploadBtn.onclick = async ()=>{
  if(!isAdmin) return;
  const file = csvFile.files[0];
  if(!file) return alert("CSV seÃ§");

  const text = await file.text();
  const satirlar = text.split("\n").slice(1);
  const mevcut = new Set(tumKitaplar.map(k=>k.ad.toLowerCase()));

  let eklenen=0;
  for(const s of satirlar){
    const ad = s.trim();
    if(ad && !mevcut.has(ad.toLowerCase())){
      await addDoc(collection(db,"kitaplar"),{ad});
      eklenen++;
    }
  }
  csvStatus.textContent = eklenen+" kitap eklendi";
  kitaplariYukle();
};
</script>

</body>
</html>
