<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Kitap Ar≈üivi | Admin Paneli</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f4f7f6; color: #333; margin:0; padding:20px; }
  header { display:flex; justify-content:space-between; align-items:center; max-width: 800px; margin: 0 auto 20px auto; }
  .box { background:#fff; padding:20px; border-radius:10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); max-width: 800px; margin: 0 auto 15px auto; }
  h2, h3 { margin-top:0; color: #2c3e50; }
  
  .sayac-box { background: #e8f0fe; color: #1967d2; font-weight: bold; text-align: center; font-size: 1.1em; border: 1px solid #d2e3fc; }
  
  input, button { padding:10px; margin-top:8px; border-radius: 5px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; }
  button { background:#3498db; color:white; border:none; cursor:pointer; font-weight: bold; transition: background 0.3s; }
  button:hover { background: #2980b9; }
  
  #logoutBtn { background: #e74c3c; width: auto; padding: 8px 15px; }
  .hidden { display:none; }
  
  ul { padding:0; list-style:none; max-width: 800px; margin: 20px auto; }
  li { background: #fff; margin-bottom: 8px; padding: 12px 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  .delete-btn { color:#e74c3c; border:1px solid #e74c3c; background:none; width: auto; margin: 0; padding: 5px 10px; font-size: 0.8em; }

  .admin-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
  .clean-btn { background: #f39c12; }
  .clean-btn:hover { background: #e67e22; }

  @media (min-width: 600px) {
    .flex-row { display: flex; gap: 10px; align-items: flex-end; }
    .flex-row input, .flex-row button { margin-top: 0; width: auto; }
    .flex-row input { flex-grow: 1; }
  }
</style>
</head>

<body>

<header>
  <h2>üìö Kitap Ar≈üivi</h2>
  <button id="logoutBtn">√áƒ±kƒ±≈ü Yap</button>
</header>

<div class="box sayac-box" id="toplamGosterge">Y√ºkleniyor...</div>

<div id="adminPanel" class="box hidden">
  <h3>‚ûï Y√∂netici ƒ∞≈ülemleri</h3>
  <div class="flex-row">
    <input id="kitapAdi" placeholder="Yeni kitap adƒ±...">
    <button id="ekleBtn">Tekli Ekle</button>
  </div>

  <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

  <label style="font-size: 12px; color: #666;">CSV Y√ºkle:</label>
  <div class="flex-row">
    <input type="file" id="csvFile" accept=".csv">
    <button id="csvUploadBtn" style="background: #27ae60;">Toplu Y√ºkle</button>
  </div>

  <div class="admin-actions">
    <button id="temizleBtn" class="clean-btn">‚ö†Ô∏è Yinelenenleri Sil</button>
    <p id="statusMsg" style="font-size: 12px; margin: auto 0;"></p>
  </div>
</div>

<div class="box">
  <div class="flex-row">
    <input id="aramaInput" placeholder="Kitap ara...">
    <button id="araBtn">Ara</button>
  </div>
</div>

<ul id="kitapListesi"></ul>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, writeBatch } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCKYXjtL0jAvcxTD09NzsQelA0ipYQFr0s",
  authDomain: "kitap-arsivi-8efa5.firebaseapp.com",
  projectId: "kitap-arsivi-8efa5",
  storageBucket: "kitap-arsivi-8efa5.firebasestorage.app",
  messagingSenderId: "712225906954",
  appId: "1:712225906954:web:b4e317515cefa3d3c89af3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const ADMIN_EMAIL = "admin@unallar.com";

let tumKitaplar = [];
let isAdmin = false;

onAuthStateChanged(auth, user => {
  if (!user) location.href = "index.html";
  isAdmin = user?.email === ADMIN_EMAIL;
  if (isAdmin) document.getElementById("adminPanel").classList.remove("hidden");
  kitaplariYukle();
});

logoutBtn.onclick = async () => { await signOut(auth); location.href = "index.html"; };

async function kitaplariYukle(){
  const snap = await getDocs(collection(db, "kitaplar"));
  tumKitaplar = [];
  snap.forEach(d => tumKitaplar.push({ id: d.id, ad: d.data().ad }));
  tumKitaplar.sort((a, b) => a.ad.localeCompare(b.ad));
  document.getElementById("toplamGosterge").textContent = `Toplam Kitap Sayƒ±sƒ±: ${tumKitaplar.length}`;
  listele(tumKitaplar);
}

function listele(liste){
  const listeEl = document.getElementById("kitapListesi");
  listeEl.innerHTML = "";
  liste.forEach((k, i) => {
    const li = document.createElement("li");
    li.innerHTML = `<span><strong>${i + 1}.</strong> ${k.ad}</span>`;
    if(isAdmin){
      const b = document.createElement("button");
      b.textContent = "Sil";
      b.className = "delete-btn";
      b.onclick = async () => {
        if(confirm(`"${k.ad}" silinsin mi?`)){
          await deleteDoc(doc(db, "kitaplar", k.id));
          kitaplariYukle();
        }
      };
      li.appendChild(b);
    }
    listeEl.appendChild(li);
  });
}

// ‚ö†Ô∏è Yƒ∞NELENENLERƒ∞ Sƒ∞LME FONKSƒ∞YONU
temizleBtn.onclick = async () => {
  if(!isAdmin || !confirm("Aynƒ± isimdeki fazla kitaplar silinecek. Emin misiniz?")) return;
  const status = document.getElementById("statusMsg");
  status.textContent = "Taranƒ±yor...";
  
  const isimHaritasi = {};
  const silinecekler = [];

  // T√ºm kitaplarƒ± tara
  tumKitaplar.forEach(k => {
    const isim = k.ad.trim().toLowerCase();
    if (isimHaritasi[isim]) {
      silinecekler.push(k.id); // Zaten varsa bu ID'yi silme listesine ekle
    } else {
      isimHaritasi[isim] = true; // ƒ∞lk kez rastlanƒ±yorsa i≈üaretle
    }
  });

  if (silinecekler.length === 0) {
    status.textContent = "M√ºkerrer kayƒ±t bulunamadƒ±.";
    return;
  }

  status.textContent = `${silinecekler.length} adet kopya siliniyor...`;
  const batch = writeBatch(db);
  silinecekler.forEach(id => {
    batch.delete(doc(db, "kitaplar", id));
  });

  await batch.commit();
  status.textContent = "Temizlik tamamlandƒ±!";
  kitaplariYukle();
};

ekleBtn.onclick = async () => {
  const ad = kitapAdi.value.trim();
  if(!ad || !isAdmin) return;
  await addDoc(collection(db, "kitaplar"), { ad });
  kitapAdi.value = "";
  kitaplariYukle();
};

araBtn.onclick = () => {
  const q = aramaInput.value.toLowerCase();
  listele(tumKitaplar.filter(k => k.ad.toLowerCase().includes(q)));
};

csvUploadBtn.onclick = async () => {
  if(!isAdmin || !csvFile.files[0]) return;
  const text = await csvFile.files[0].text();
  const satirlar = text.split("\n").map(s => s.trim()).filter(s => s);
  const mevcutlar = new Set(tumKitaplar.map(k => k.ad.toLowerCase()));
  
  for(let ad of satirlar){
    if(!mevcutlar.has(ad.toLowerCase())){
      await addDoc(collection(db, "kitaplar"), { ad });
      mevcutlar.add(ad.toLowerCase());
    }
  }
  kitaplariYukle();
};
</script>

</body>
</html>
